@page "{id:int}"
@model Fruit_Store_PRJ.Areas.Admin.Pages.Orders.OrderDetailModel
@{
    ViewData["Title"] = "Chi tiết đơn hàng #" + Model.Order.OrderCode;
}

<div class="d-flex justify-content-between align-items-center mb-4 d-print-none">
    <a asp-page="Index" class="btn btn-sm btn-outline-secondary">
        <i class="fa-solid fa-chevron-left me-1"></i> Danh sách hóa đơn
    </a>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-dark" onclick="window.print()">
            <i class="fa-solid fa-print me-1"></i> In hóa đơn
        </button>

        @if (Model.Order.Status != 4 && Model.Order.Status != 3)
        {
            <form method="post" asp-page-handler="UpdateStatus" asp-route-id="@Model.Order.Id" asp-route-status="4">
                <button type="submit" class="btn btn-sm btn-outline-danger px-3">
                    <i class="fa-solid fa-ban me-1"></i> Hủy đơn
                </button>
            </form>
        }

        <div class="btn-group shadow-sm">
            @switch (Model.Order.Status)
            {
                case 1:
                    <form method="post" asp-page-handler="UpdateStatus" asp-route-id="@Model.Order.Id" asp-route-status="2">
                        <button type="submit" class="btn btn-sm btn-primary px-3">Xác nhận & Giao hàng</button>
                    </form>
                    break;
                case 2:
                    <form method="post" asp-page-handler="UpdateStatus" asp-route-id="@Model.Order.Id" asp-route-status="3">
                        <button type="submit" class="btn btn-sm btn-success px-3">Xác nhận Hoàn thành</button>
                    </form>
                    break;
            }
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4 d-print-none">
    <div class="card-body py-5">
        <div class="position-relative d-flex justify-content-between">
            @{
                int progress = Model.Order.Status switch { 1 => 25, 2 => 65, 3 => 100, _ => 0 };
                string barClass = Model.Order.Status == 4 ? "bg-danger" : "bg-success";
            }
            <div class="progress position-absolute start-0 top-50 translate-middle-y w-100" style="height: 4px; z-index: 0; transform: translateY(-15px) !important;">
                <div class="progress-bar @barClass" role="progressbar" style="width: @progress%;"></div>
            </div>

            <div class="text-center position-relative" style="z-index: 1; width: 120px;">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3 shadow" style="width: 50px; height: 50px;">
                    <i class="fa-solid fa-file-invoice fs-5"></i>
                </div>
                <div class="small fw-bold text-dark mb-1">Đã đặt hàng</div>
                <div class="text-muted" style="font-size: 0.75rem;">@Model.Order.OrderDate.ToString("HH:mm dd/MM/yyyy")</div>
            </div>

            <div class="text-center position-relative" style="z-index: 1; width: 120px;">
                <div class="@(Model.Order.Status >= 2 ? "bg-success text-white" : "bg-white text-secondary border border-3") rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3 shadow" style="width: 50px; height: 50px;">
                    <i class="fa-solid fa-truck fs-5"></i>
                </div>
                <div class="small fw-bold @(Model.Order.Status >= 2 ? "text-dark" : "text-muted") mb-1">Đang giao</div>
            </div>

            <div class="text-center position-relative" style="z-index: 1; width: 120px;">
                <div class="@(Model.Order.Status == 3 ? "bg-success text-white" : "bg-white text-secondary border border-3") rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3 shadow" style="width: 50px; height: 50px;">
                    <i class="fa-solid fa-circle-check fs-5"></i>
                </div>
                <div class="small fw-bold @(Model.Order.Status == 3 ? "text-dark" : "text-muted") mb-1">Hoàn thành</div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-3 overflow-hidden position-relative">
    <div class="card-body p-4 p-md-5 position-relative" style="z-index: 1;">
        <div class="row mb-5">
            <div class="col-sm-6 text-center text-sm-start">
                <h3 class="text-success fw-bold mb-1 text-uppercase">FruitFresh Admin</h3>
                <p class="text-muted small mb-0">Hệ thống quản lý nội bộ</p>
            </div>
            <div class="col-sm-6 text-center text-sm-end">
                <h2 class="fw-light text-secondary mb-0">HÓA ĐƠN</h2>
                <div class="fw-bold fs-5 text-primary">#@Model.Order.OrderCode</div>
                <p class="text-muted small">Ngày tạo: @Model.Order.CreatedAt.ToString("dd/MM/yyyy")</p>
            </div>
        </div>

        <div class="row mb-5 g-4 bg-light mx-0 py-4 rounded-3 border">
            <div class="col-sm-6 col-md-4 px-4">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Thông tin khách hàng</h6>
                <div class="fw-bold fs-6">@Model.Order.CustomerName</div>
                <div class="text-muted small mt-1"><i class="fa-solid fa-phone me-1"></i> @Model.Order.CustomerPhone</div>
                <div class="text-muted small"><i class="fa-solid fa-user me-1"></i> Account: @Model.Order.Account.Username</div>
            </div>
            <div class="col-sm-6 col-md-4 px-4 border-sm-start">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Địa chỉ giao hàng</h6>
                <div class="text-dark mb-1">@Model.Order.ShippingAddress</div>
            </div>
            <div class="col-md-4 px-4 border-md-start">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Thanh toán & Trạng thái</h6>
                <div class="mb-1">
                    @if (Model.Order.Status == 3)
                    {
                        <span class="badge bg-success px-3">Đã hoàn thành</span>
                    }
                    else if (Model.Order.Status == 4)
                    {

                        <span class="badge bg-danger px-3">Đã hủy</span>
                    }
                    else
                    {

                        <span class="badge bg-warning text-dark px-3">Đang xử lý</span>
                    }
                </div>
                <div class="small"><span class="text-muted">Phương thức:</span> <b class="text-dark">@(Model.Order.PaymentMethod == 1 ? "COD" : "Chuyển khoản")</b></div>
            </div>
        </div>

        <div class="table-responsive mb-4">
            <table class="table table-hover align-middle">
                <thead class="bg-light">
                    <tr class="text-uppercase small fw-bold text-secondary border-top border-bottom">
                        <th class="py-3 ps-3">Sản phẩm</th>
                        <th class="py-3 text-center">Đơn giá</th>
                        <th class="py-3 text-center">Số lượng</th>
                        <th class="py-3 text-end pe-3">Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Order.OrderItems)
                    {
                        <tr>
                            <td class="py-3 ps-3">
                                <div class="fw-bold text-dark">@item.ProductName</div>
                                <small class="text-muted">ĐVT: @item.UnitName</small>
                            </td>
                            <td class="py-3 text-center text-muted">@item.Price.ToString("N0")đ</td>
                            <td class="py-3 text-center fw-bold">@item.Quantity</td>
                            <td class="py-3 text-end pe-3 fw-bold text-dark">@item.SubTotal.ToString("N0")đ</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="row justify-content-end">
            <div class="col-md-5 col-lg-4">
                <div class="card bg-light border-0">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 fw-bold mb-0">TỔNG THANH TOÁN:</span>
                            <span class="h4 fw-bold text-success mb-0">@Model.Order.TotalAmount.ToString("N0")đ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.Order.Note))
        {
            <div class="mt-4 p-3 border-start border-4 border-warning bg-warning-subtle rounded-end">
                <h6 class="fw-bold mb-1 small text-uppercase text-warning-emphasis">Ghi chú:</h6>
                <p class="mb-0 text-dark small italic">"@Model.Order.Note"</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <style>
        @@media print {
            #admin-sidebar, .admin-navbar, .admin-footer, .btn, .btn-group, .mb-4:first-child {
                display: none !important;
            }

            #admin-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }

            .card {
                border: 1px solid #ddd !important;
                box-shadow: none !important;
            }

            .bg-light {
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
            }

            .badge {
                border: 1px solid #000 !important;
                color: #000 !important;
            }
        }
    </style>
}