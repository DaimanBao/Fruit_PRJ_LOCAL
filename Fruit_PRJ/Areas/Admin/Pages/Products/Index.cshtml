@page 
@model Fruit_Store_PRJ.Areas.Admin.Pages.Products.IndexModel
@{
    ViewData["Title"] = "Quản lý Sản phẩm";
    var Message = Model.Message;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-success fw-bold m-0"><i class="fa-solid fa-apple-whole me-2"></i>Danh sách Trái cây</h2>
</div>

<!--CARD HIEN THI THONG TIN QUAN LY SAN PHAM-->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm p-3 border-start border-primary border-4">
            <div class="d-flex align-items-center">
                <div class="bg-primary-subtle text-primary rounded-3 p-3 me-3">
                    <i class="fa-solid fa-boxes-stacked fs-4"></i>
                </div>
                <div>
                    <div class="text-muted small fw-bold">Tổng sản phẩm</div>
                    <div class="h5 fw-bold mb-0">@Model.TotalProducts</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm p-3 border-start border-success border-4">
            <div class="d-flex align-items-center">
                <div class="bg-success-subtle text-success rounded-3 p-3 me-3">
                    <i class="fa-solid fa-circle-check fs-4"></i>
                </div>
                <div>
                    <div class="text-muted small fw-bold">Đang bán</div>
                    <div class="h5 fw-bold mb-0">@Model.SellingProducts</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm p-3 border-start border-danger border-4">
            <div class="d-flex align-items-center">
                <div class="bg-danger-subtle text-warning rounded-3 p-3 me-3">
                    <i class="fa-solid fa-triangle-exclamation fs-4" style="color: red;"></i>
                </div>
                <div>
                    <div class="text-muted small fw-bold">Hết hàng</div>
                    <div class="h5 fw-bold mb-0">@Model.OutOfStockProducts</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm p-3 border-start border-secondary border-4">
            <div class="d-flex align-items-center">
                <div class="bg-secondary-subtle text-danger rounded-3 p-3 me-3">
                    <i class="fa-solid fa-circle-minus fs-4" style="color: gray"></i>
                </div>
                <div>
                    <div class="text-muted small fw-bold">Ngừng bán</div>
                    <div class="h5 fw-bold mb-0">@Model.StopSellingProducts</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--BO LOC-->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <!--SEARCH-->
            <div class="col-md-5">
                <label class="small fw-bold text-muted">Tìm kiếm</label>
                <input type="text"
                       name="SearchKeyword"
                       value="@Model.SearchKeyword"
                       class="form-control"
                       placeholder="Tên hoặc mã sản phẩm...">
            </div>

            <!--CATEGORY-->
            <div class="col-md-4">
                <label class="small fw-bold text-muted">Danh mục</label>
                <select class="form-select" name="FilterCategoryId">
                    <option value="">Chọn danh mục...</option>
                    @foreach (var category in Model.categories)
                    {
                        <option value="@category.Id"
                                selected="@(Model.FilterCategoryId == category.Id)">
                            @category.Name
                        </option>
                    }
                </select>
            </div>
            <!--ORIGIN-->
            <div class="col-md-3">
                <label class="small fw-bold text-muted">Xuất xứ</label>
                <select class="form-select" name="FilterOriginId">
                    <option value="">Chọn xuất xứ...</option>
                    @foreach (var origin in Model.origins)
                    {
                        <option value="@origin.Id"
                                selected="@(Model.FilterOriginId == origin.Id)">
                            @origin.Name
                        </option>
                    }
                </select>
            </div>
            <!--UNIT-->
            <div class="col-md-4">
                <label class="small fw-bold text-muted">Đơn vị</label>
                <select class="form-select" name="FilterUnitId">
                    <option value="">Chọn đơn vị...</option>
                    @foreach (var unit in Model.units)
                    {
                        <option value="@unit.Id"
                                selected="@(Model.FilterUnitId == unit.Id)">
                            @unit.Name
                        </option>
                    }
                </select>
            </div>
            <!--STATUS-->
            <div class="col-md-4">
                <label class="small fw-bold text-muted">Trạng thái</label>
                <select class="form-select" name="FilterStatus">
                    <option value="">Tất cả trạng thái</option>
                    <option value="1" selected="@(Model.FilterStatus == 1)">Đang bán</option>
                    <option value="2" selected="@(Model.FilterStatus == 2)">Hết hàng</option>
                    <option value="3" selected="@(Model.FilterStatus == 3)">Ngừng bán</option>
                </select>
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Lọc dữ liệu</button>
            </div>
            <!-- NUT THEM -->
            <div class="col-12 mt-3 pt-3 border-top d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-success col-3" data-bs-toggle="modal" data-bs-target="#AddProductModal">
                    <i class="fa-solid fa-circle-plus me-1"></i> Thêm sản phẩm
                </button>
                <button type="button" class="btn btn-sm btn-outline-info col-3" data-bs-toggle="modal" data-bs-target="#AddCategoryModal">
                    <i class="fa-solid fa-folder-plus me-1"></i> Thêm danh mục
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary col-3" data-bs-toggle="modal" data-bs-target="#AddOriginModal">
                    <i class="fa-solid fa-folder-plus me-1"></i> Thêm xuất xứ
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary col-3" data-bs-toggle="modal" data-bs-target="#AddUnitModal">
                    <i class="fa-solid fa-ruler-combined me-1"></i> Thêm đơn vị
                </button>
            </div>

        </form>
    </div>
</div>

<!--BANG SAN PHAM-->
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <!--COT THONG TIN-->
                    <tr>
                        <th class="ps-4" style="width: 80px;">Ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Xuất xứ</th>
                        <th>Danh mục</th>
                        <th>Đơn vị</th>
                        <th>Kho</th>
                        <th>Giá bán</th>
                        <th>Trạng thái</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                </thead>
                <!--DONG THONG TIN-->
                <tbody>
                    @foreach(var product in Model.products)
                    {
                        var mainImage = product.ProductImages.FirstOrDefault(i => i.IsMain);
                       
                        <tr>
                            <!-- ẢNH -->
                            <td class="ps-4">
                                <img src="@(mainImage != null ? mainImage.ImageUrl : "/images/no-image.png")"
                                     class="rounded border"
                                     style="width:50px;height:50px;object-fit:cover"
                                     alt="Sản phẩm">
                            </td>

                            <!-- TÊN -->
                            <td>
                                <div class="fw-bold text-dark">@product.Name</div>
                                <small class="text-muted">Mã: @product.Sku</small>
                            </td>

                            <!-- XUẤT XỨ -->
                            <td>@product.Origin.Name</td>

                            <!-- DANH MỤC -->
                            <td>
                                <span class="badge bg-light text-dark border">
                                    @product.Category.Name
                                </span>
                            </td>

                            <!-- ĐƠN VỊ -->
                            <td>@product.Unit.Name</td>

                            <!-- KHO -->
                            <td class="fw-bold">@product.Stock</td>

                            <!-- GIÁ -->
                            <td class="text-danger fw-bold">
                                @product.Price.ToString("N0") đ
                            </td>

                            <!-- TRẠNG THÁI -->
                            <td>
                                <span class="badge bg-@Model.GetStatusClass(product.Status)-subtle text-@Model.GetStatusClass(product.Status) border">
                                    @Model.GetStatusText(product.Status)
                                </span>
                            </td>

                            <!-- THAO TÁC -->
                            <td class="text-center">
                                <div class="btn-group shadow-sm">
                                    <!--XEM CHI TIET-->
                                    <a asp-page="ProductDetail"
                                       asp-route-id="@product.Id"
                                       class="btn btn-sm btn-outline-info">
                                        <i class="fa-solid fa-eye"></i>
                                    </a>
                                    <!--XOA SAN PHAM-->
                                     <form method="post"
                                            asp-page-handler="DeleteProduct"
                                            asp-route-id="@product.Id"
                                            onsubmit="return confirm('Bạn có chắc muốn xoá sản phẩm này không?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </form>

                                </div>
                            </td>
                        </tr>
                    }
                       
                </tbody>
            </table>
        </div>
    </div>
    <!--PAGINATION-->
    <div class="card-footer bg-white d-flex justify-content-between align-items-center py-3">
        <span class="small text-muted font-monospace">
            Hiển thị @Model.products.Count / @Model.TotalItems sản phẩm
        </span>

        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm m-0">

                <!-- PREVIOUS -->
                <li class="page-item @(Model.PageIndex == 1 ? "disabled" : "")">
                    <a class="page-link shadow-none"
                       asp-page="./Index"
                       asp-route-PageIndex="@(Model.PageIndex - 1)"
                       asp-route-SearchKeyword="@Model.SearchKeyword"
                       asp-route-CategoryId="@Model.FilterCategoryId"
                       asp-route-OriginId="@Model.FilterOriginId"
                       asp-route-UnitId="@Model.FilterUnitId"
                       asp-route-Status="@Model.FilterStatus">
                        Trước
                    </a>
                </li>

                <!-- PAGE NUMBER -->
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                        <a class="page-link shadow-none"
                           asp-page="./Index"
                           asp-route-PageIndex="@i"
                           asp-route-SearchKeyword="@Model.SearchKeyword"
                           asp-route-CategoryId="@Model.FilterCategoryId"
                           asp-route-OriginId="@Model.FilterOriginId"
                           asp-route-UnitId="@Model.FilterUnitId"
                           asp-route-Status="@Model.FilterStatus">
                            @i
                        </a>
                    </li>
                }

                <!-- NEXT -->
                <li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link shadow-none"
                       asp-page="./Index"
                       asp-route-PageIndex="@(Model.PageIndex + 1)"
                       asp-route-SearchKeyword="@Model.SearchKeyword"
                       asp-route-CategoryId="@Model.FilterCategoryId"
                       asp-route-OriginId="@Model.FilterOriginId"
                       asp-route-UnitId="@Model.FilterUnitId"
                       asp-route-Status="@Model.FilterStatus">
                        Sau
                    </a>
                </li>

            </ul>
        </nav>
    </div>

</div>
@if(Model.Message != null)
{
    <div class="offcanvas offcanvas-end show" tabindex="-1" id="offcanvas" aria-labelledby="offcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasLabel">Thông báo lỗi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            @Model.Message
        </div>
    </div>
}

@await Html.PartialAsync("_AddProductModal")
@await Html.PartialAsync("_AddCategoryModal")
@await Html.PartialAsync("_AddUnitModal")
@await Html.PartialAsync("_AddOriginModal")
